{% extends 'base.html' %}

{% block content %}
<div style="height: 100px;"></div>

<style>
    .product-image {
        display: block;
        width: 300px;
        height: auto;
        margin: 0 auto;
    }

    .name {
        font-size: 20px;
        margin-top: 10px;
        font-weight: bold;
        text-align: center;
    }

    .avg_score {
        font-size: 24px;
        margin-top: 10px;
    }

    .recommend {
        font-size: 14px;
        text-align: center;
    }

    table {
        border-collapse: collapse;
        width: 100%;
        height: 100px;
    }

    th, td {
        border: 1px solid black;
        padding: 0px;
        text-align: center;
        font-size: 14px;
        height: 30px;
    }

    th:first-child, td:nth-child(3),
    td:first-child {
        text-align: center;
        font-weight: bold;
    }

    td:first-child, td:nth-child(3) {
        font-size: 14px;
        background-color: #e9ecef;
    }

    .nutrient {
        width: 100%;
        height: 100px;
        display: plex;
    }

    tr:nth-child(1) > th {
        text-align: right;
        font-size: 13px;
        padding-right: 20px;
        border: none;
    }
    .box1 { 
        color: black;
        text-align:center;
    }

</style>

<a href="{{product.site_url}}" class="box1">
    <img src="{{product.image_url}}" class="product-image">
    <p >í•´ë‹¹ ì œí’ˆ ì‚¬ì´íŠ¸ë¡œ ì´ë™ â–¶ï¸</p>
</a>

<div class="like-container">
    <button class="like-button" data-product-id="{{ product.product_id }}">
        {% if user.is_authenticated %}
            {% if is_liked %}
                ì¢‹ì•„ìš” ì·¨ì†Œ
            {% else %}
                ì¢‹ì•„ìš”
            {% endif %}
        {% else %}
            ì¢‹ì•„ìš”
        {% endif %}
    </button>
</div>

<div class="name-container">
    <p class="name">
        <span class="heart-icon">
            {% if is_liked %}
                â¤ï¸
            {% else %}
                ğŸ–¤
            {% endif %}
        </span>
        [{{ product.patient_category }}] {{ product.product_name }}
    </p>
</div>

<canvas id="myChart" width="400" height="200"></canvas>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
<script>
    {% if product.patient_category == 'ë‹¹ë‡¨' %}
    let myCt = document.getElementById('myChart');
    let myChart = new Chart(myCt, {
        type: 'bar',
        options: {
            indexAxis: 'y',
            plugins: {
                subtitle: {
                    display: true,
                    text: '[ë‹¹ë‡¨í™˜ìë¥¼ ìœ„í•œ ë‹¹ í•¨ëŸ‰ ê¸°ì¤€ í‘œ(g)]'
                }
            }
        },
        data: {
            labels: ['ë‹¹ ê¶Œì¥ ì„­ì·¨ëŸ‰', 'í•´ë‹¹ìƒí’ˆ', 'ë‹¹ì‚¬ í‰ê· '],
            datasets: [
                {
                    label: '65kg ì„±ì¸ í•œë¼ ê¸°ì¤€',
                    data: [3.33, {{ product.sugars }}, {{ avg_sugars|default:0 }}],
                    backgroundColor: ['#ccfcfc', '#2ecc71', '#ccfcfc'],
                    borderColor: 'white',
                    maxBarThickness: 30
                }
            ]
        },
    });
    {% endif %}

    {% if product.patient_category == 'ì‹ ì¥ì§ˆí™˜' %}
    let myCt = document.getElementById('myChart');
    let myChart = new Chart(myCt, {
        type: 'bar',
        options: {
            indexAxis: 'y',
            plugins: {
                subtitle: {
                    display: true,
                    text: 'ì‹ ì¥ì§ˆí™˜ìë¥¼ ìœ„í•œ ë‚˜íŠ¸ë¥¨ ê¸°ì¤€ í‘œ(mg)'
                }
            }
        },
        data: {
            labels: ['ë‚˜íŠ¸ë¥¨ ê¶Œì¥ ì„­ì·¨ëŸ‰', 'í•´ë‹¹ìƒí’ˆ', 'ë‹¹ì‚¬ í‰ê· '],
            datasets: [
                {
                    label: '65kg ì„±ì¸ í•œë¼ ê¸°ì¤€',
                    data: [266, {{ product.na }}, {{ avg_na|default:0 }}],
                    backgroundColor: ['#ccfcfc', '#2ecc71', '#ccfcfc'],
                    borderColor: 'white',
                    borderWidth: 2,
                    maxBarThickness: 30
                }
            ]
        },
    });
    {% endif %}

    {% if product.patient_category == 'ì•”ì§ˆí™˜' %}
    let myCt = document.getElementById('myChart');
    let myChart = new Chart(myCt, {
        type: 'bar',
        options: {
            indexAxis: 'y',
            plugins: {
                subtitle: {
                    display: true,
                    text: 'ì•” ì§ˆí™˜ìë¥¼ ìœ„í•œ ë‹¨ë°±ì§ˆ ê¸°ì¤€í‘œ(kcal)'
                }
            }
        },
        data: {
            labels: ['ë‹¨ë°±ì§ˆ ìœ ë˜ì—´ëŸ‰ ìµœì†Œê¸°ì¤€ì¹˜ ', 'í•´ë‹¹ ìƒí’ˆ', 'ë‹¹ì‚¬ í‰ê· '],
            datasets: [
                {
                    label: 'ì•”ì§ˆí™˜ìë¥¼ ìœ„í•œ ë‹¨ë°±ì§ˆ ê¸°ì¤€í‘œ(kcal)',
                    data: [{{product.calorie}} * 0.18 , {{product.protein}} * 4 , {{ avg_protein|default:0 }}], // ë‹¨ë°±ì§ˆì€ 1gë‹¹ 4kcal (ìœ ë˜ì—´ëŸ‰), ê¸°ì¤€ì¹˜ ì—´ëŸ‰ì˜ 18% ì´ìƒ ( ì¹¼ë¡œë¦¬ * 0.18 )
                    backgroundColor: ['#ccfcfc', '#2ecc71', '#ccfcfc'],
                    borderColor: 'white',
                    borderWidth: 2,
                    maxBarThickness: 30
                }
            ]
        },
    });
    {% endif %}
</script>

{% if product.patient_category == 'ë‹¹ë‡¨' %}
    <p class="recommend">ë‹¹ë‡¨í™˜ìê°€ ìœ ì˜í•´ì•¼ í•  ì˜ì–‘ì„±ë¶„ì€ <b>'ë‹¹'</b> ì…ë‹ˆë‹¤</p>
{% endif %}

{% if product.patient_category == 'ì‹ ì¥ì§ˆí™˜' %}
    <p class="recommend">ì‹ ì¥ì§ˆí™˜ìê°€ ìœ ì˜í•´ì•¼ í•  ì˜ì–‘ì„±ë¶„ì€ <b>'ë‚˜íŠ¸ë¥¨'</b> ì…ë‹ˆë‹¤ </p>
{% endif %}

{% if product.patient_category == 'ì•”ì§ˆí™˜' %}
    <p class="recommend">ì•”ì§ˆí™˜ìê°€ ìœ ì˜í•´ì•¼ í•  ì˜ì–‘ì„±ë¶„ì€ <b>'ë‹¨ë°±ì§ˆ'</b> ì…ë‹ˆë‹¤ </p>
{% endif %}

<div class="nutrient">
    <table>
        <tbody>
            <tr>
                <th colspan="2" style="text-align:left;">
                    ì˜ì–‘ì„±ë¶„í‘œ
                </th>
                <th colspan="2">
                    (100gê¸°ì¤€)
                </th>
            </tr>
            <tr>
                <td>ì—´ëŸ‰</td>
                <td>{{ product.calorie }} (kcal)</td>
                <td>íƒ„ìˆ˜í™”ë¬¼</td>
                <td>{{ product.carbohydrate }} (g)</td>
            </tr>
            <tr>
                <td>ë‹¨ë°±ì§ˆ</td>
                <td>{{ product.protein }} (g)</td>
                <td>ì§€ë°©</td>
                <td>{{ product.fat }} (g)</td>
            </tr>
            <tr>
                <td>ë‹¹</td>
                <td>{{ product.sugars }} (g)</td>
                <td>ë‚˜íŠ¸ë¥¨</td>
                <td>{{ product.na }} (mg)</td>
            </tr>
        </tbody>
    </table>
</div>

<script>
    $(document).ready(function() {
        $('.like-button').click(function() {
            var button = $(this);
            var productId = button.data('product-id');

            $.ajax({
                url: '/main/product/' + productId + '/like/',
                method: 'POST',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (button.text() === 'ì¢‹ì•„ìš”') {
                        button.text('ì¢‹ì•„ìš” ì·¨ì†Œ');
                        $('.heart-icon').text('â¤ï¸');
                    } else {
                        button.text('ì¢‹ì•„ìš”');
                        $('.heart-icon').text('ğŸ–¤');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('ì¢‹ì•„ìš” í† ê¸€ ì—ëŸ¬:', error);
                }
            });
        });
    });
</script>
<div style="height: 80px;"></div>

{% endblock %}



ìˆ˜ì •ì‚¬í•­ 2. view ì¼ë¶€ product_detail

def product_detail(request, product_id):
    product = get_object_or_404(Product, product_id=product_id)
    is_liked = False

    if request.user.is_authenticated:
        is_liked = Like.objects.filter(user=request.user, product=product).exists()
    diabetes_products = Product.objects.filter(patient_category='ë‹¹ë‡¨')
    total_sugars = sum([p.sugars for p in diabetes_products])
    diabetes_count = diabetes_products.count()
    avg_sugars = total_sugars / diabetes_count if diabetes_count > 0 else 0

    kidney_products = Product.objects.filter(patient_category='ì‹ ì¥ì§ˆí™˜')
    total_na = sum([p.na for p in kidney_products])
    kidney_count = kidney_products.count()
    avg_na = total_na / kidney_count if kidney_count > 0 else 0

    cancer_products = Product.objects.filter(patient_category='ì•”ì§ˆí™˜')
    total_protein = sum([p.protein for p in cancer_products])
    cancer_count = cancer_products.count()
    avg_protein = total_protein / cancer_count if cancer_count > 0 else 0

    

    return render(request, "main/product_detail.html", {
        'product': product,
        'avg_sugars': avg_sugars,
        'avg_na': avg_na,
        'avg_protein': avg_protein,
        'is_liked':is_liked
    })

